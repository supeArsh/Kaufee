{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>User Management</h1>
        <p class="text-muted">Manage system users and assign roles</p>
    </div>
    <div class="col-md-4 text-md-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newUserModal">
            <i class="fas fa-plus me-2"></i>Create User
        </button>
    </div>
</div>

<!-- Users Table -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-transparent">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">System Users</h5>
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text border-0 bg-transparent">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="userSearch" class="form-control border-0 bg-light" placeholder="Search users...">
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if users %}
                        {% for user in users %}
                            <tr>
                                <td>
                                    <i class="fas fa-user me-2"></i>{{ user.username }}
                                    {% if user.id == current_user.id %}
                                    <span class="badge bg-info ms-2">You</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <span class="badge bg-{{ {'admin': 'danger', 'manager': 'warning', 'staff': 'secondary'}[user.role] }}">
                                        {{ user.role.upper() }}
                                    </span>
                                </td>
                                <td>
                                    {% if user.id != current_user.id %}
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" data-bs-toggle="modal" 
                                                data-bs-target="#editRoleModal{{ user.id }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form method="POST" action="{{ url_for('delete_user_route', id=user.id) }}" 
                                              style="display: inline;" 
                                              onsubmit="return confirm('Are you sure you want to delete this user?');">
                                            <button type="submit" class="btn btn-outline-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            
                            <!-- Edit Role Modal -->
                            <div class="modal fade" id="editRoleModal{{ user.id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Update User Role</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <form method="POST" action="{{ url_for('update_user_role', id=user.id) }}">
                                            <div class="modal-body">
                                                <p class="mb-3">Assign role for: <strong>{{ user.username }}</strong></p>
                                                <div class="mb-3">
                                                    <label class="form-label">Role</label>
                                                    <select name="role" class="form-select" required>
                                                        <option value="staff" {% if user.role == 'staff' %}selected{% endif %}>Staff</option>
                                                        <option value="manager" {% if user.role == 'manager' %}selected{% endif %}>Manager</option>
                                                        <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                                                    </select>
                                                </div>
                                                <div class="alert alert-info small" role="alert">
                                                    <strong>Roles:</strong><br>
                                                    <strong>Staff:</strong> Can create orders and view menu<br>
                                                    <strong>Manager:</strong> Can manage menu, staff, inventory, and reports<br>
                                                    <strong>Admin:</strong> Full system access
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-primary">Save Role</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <p class="text-muted mb-0">No users found</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create New User Modal -->
<div class="modal fade" id="newUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('users') }}" novalidate>
                {{ form.hidden_tag() }}
                <div class="modal-body">
                    <div class="mb-3">
                        {{ form.username.label(class="form-label") }}
                        {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else "")) }}
                        {% if form.username.errors %}
                            <div class="invalid-feedback">{{ form.username.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ form.email.label(class="form-label") }}
                        {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else "")) }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback">{{ form.email.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ form.password.label(class="form-label") }}
                        {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else "")) }}
                        {% if form.password.errors %}
                            <div class="invalid-feedback">{{ form.password.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ form.role.label(class="form-label") }}
                        {{ form.role(class="form-select" + (" is-invalid" if form.role.errors else "")) }}
                        {% if form.role.errors %}
                            <div class="invalid-feedback">{{ form.role.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // User search functionality
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('userSearch');
        const table = document.querySelector('table');
        const rows = table.querySelectorAll('tbody tr');
        
        searchInput.addEventListener('keyup', function() {
            const query = this.value.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });
    });
</script>
{% endblock %}
